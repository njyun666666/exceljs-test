{"version":3,"sources":["../../../lib/utils/xml-stream.js"],"names":["_","require","utils","OPEN_ANGLE","CLOSE_ANGLE","OPEN_ANGLE_SLASH","CLOSE_SLASH_ANGLE","EQUALS_QUOTE","QUOTE","SPACE","pushAttribute","xml","name","value","push","xmlEncode","toString","pushAttributes","attributes","each","undefined","XmlStream","_xml","_stack","_rollbacks","length","docAttributes","parent","tos","open","leaf","Error","attrs","text","node","pop","openNode","writeText","closeNode","stack","cursor","r","splice","closeAll","join","StdDocAttributes","version","encoding","standalone","module","exports"],"mappings":"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","sourcesContent":["const _ = require('./under-dash');\r\n\r\nconst utils = require('./utils');\r\n\r\n// constants\r\nconst OPEN_ANGLE = '<';\r\nconst CLOSE_ANGLE = '>';\r\nconst OPEN_ANGLE_SLASH = '</';\r\nconst CLOSE_SLASH_ANGLE = '/>';\r\nconst EQUALS_QUOTE = '=\"';\r\nconst QUOTE = '\"';\r\nconst SPACE = ' ';\r\n\r\nfunction pushAttribute(xml, name, value) {\r\n  xml.push(SPACE);\r\n  xml.push(name);\r\n  xml.push(EQUALS_QUOTE);\r\n  xml.push(utils.xmlEncode(value.toString()));\r\n  xml.push(QUOTE);\r\n}\r\nfunction pushAttributes(xml, attributes) {\r\n  if (attributes) {\r\n    _.each(attributes, (value, name) => {\r\n      if (value !== undefined) {\r\n        pushAttribute(xml, name, value);\r\n      }\r\n    });\r\n  }\r\n}\r\n\r\nclass XmlStream {\r\n  constructor() {\r\n    this._xml = [];\r\n    this._stack = [];\r\n    this._rollbacks = [];\r\n  }\r\n\r\n  get tos() {\r\n    return this._stack.length ? this._stack[this._stack.length - 1] : undefined;\r\n  }\r\n\r\n  get cursor() {\r\n    // handy way to track whether anything has been added\r\n    return this._xml.length;\r\n  }\r\n\r\n  openXml(docAttributes) {\r\n    const xml = this._xml;\r\n    // <?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>\r\n    xml.push('<?xml');\r\n    pushAttributes(xml, docAttributes);\r\n    xml.push('?>\\n');\r\n  }\r\n\r\n  openNode(name, attributes) {\r\n    const parent = this.tos;\r\n    const xml = this._xml;\r\n    if (parent && this.open) {\r\n      xml.push(CLOSE_ANGLE);\r\n    }\r\n\r\n    this._stack.push(name);\r\n\r\n    // start streaming node\r\n    xml.push(OPEN_ANGLE);\r\n    xml.push(name);\r\n    pushAttributes(xml, attributes);\r\n    this.leaf = true;\r\n    this.open = true;\r\n  }\r\n\r\n  addAttribute(name, value) {\r\n    if (!this.open) {\r\n      throw new Error('Cannot write attributes to node if it is not open');\r\n    }\r\n    if (value !== undefined) {\r\n      pushAttribute(this._xml, name, value);\r\n    }\r\n  }\r\n\r\n  addAttributes(attrs) {\r\n    if (!this.open) {\r\n      throw new Error('Cannot write attributes to node if it is not open');\r\n    }\r\n    pushAttributes(this._xml, attrs);\r\n  }\r\n\r\n  writeText(text) {\r\n    const xml = this._xml;\r\n    if (this.open) {\r\n      xml.push(CLOSE_ANGLE);\r\n      this.open = false;\r\n    }\r\n    this.leaf = false;\r\n    xml.push(utils.xmlEncode(text.toString()));\r\n  }\r\n\r\n  writeXml(xml) {\r\n    if (this.open) {\r\n      this._xml.push(CLOSE_ANGLE);\r\n      this.open = false;\r\n    }\r\n    this.leaf = false;\r\n    this._xml.push(xml);\r\n  }\r\n\r\n  closeNode() {\r\n    const node = this._stack.pop();\r\n    const xml = this._xml;\r\n    if (this.leaf) {\r\n      xml.push(CLOSE_SLASH_ANGLE);\r\n    } else {\r\n      xml.push(OPEN_ANGLE_SLASH);\r\n      xml.push(node);\r\n      xml.push(CLOSE_ANGLE);\r\n    }\r\n    this.open = false;\r\n    this.leaf = false;\r\n  }\r\n\r\n  leafNode(name, attributes, text) {\r\n    this.openNode(name, attributes);\r\n    if (text !== undefined) {\r\n      // zeros need to be written\r\n      this.writeText(text);\r\n    }\r\n    this.closeNode();\r\n  }\r\n\r\n  closeAll() {\r\n    while (this._stack.length) {\r\n      this.closeNode();\r\n    }\r\n  }\r\n\r\n  addRollback() {\r\n    this._rollbacks.push({\r\n      xml: this._xml.length,\r\n      stack: this._stack.length,\r\n      leaf: this.leaf,\r\n      open: this.open,\r\n    });\r\n    return this.cursor;\r\n  }\r\n\r\n  commit() {\r\n    this._rollbacks.pop();\r\n  }\r\n\r\n  rollback() {\r\n    const r = this._rollbacks.pop();\r\n    if (this._xml.length > r.xml) {\r\n      this._xml.splice(r.xml, this._xml.length - r.xml);\r\n    }\r\n    if (this._stack.length > r.stack) {\r\n      this._stack.splice(r.stack, this._stack.length - r.stack);\r\n    }\r\n    this.leaf = r.leaf;\r\n    this.open = r.open;\r\n  }\r\n\r\n  get xml() {\r\n    this.closeAll();\r\n    return this._xml.join('');\r\n  }\r\n}\r\n\r\nXmlStream.StdDocAttributes = {\r\n  version: '1.0',\r\n  encoding: 'UTF-8',\r\n  standalone: 'yes',\r\n};\r\n\r\nmodule.exports = XmlStream;\r\n"],"file":"xml-stream.js"}