{"version":3,"sources":["../../../../lib/stream/xlsx/worksheet-writer.js"],"names":["_","require","RelType","colCache","Encryptor","Dimensions","StringBuf","Row","Column","SheetRelsWriter","SheetCommentsWriter","DataValidations","xmlBuffer","ListXform","DataValidationsXform","SheetPropertiesXform","SheetFormatPropertiesXform","ColXform","RowXform","HyperlinkXform","SheetViewXform","SheetProtectionXform","PageMarginsXform","PageSetupXform","AutoFilterXform","PictureXform","ConditionalFormattingsXform","HeaderFooterXform","RowBreaksXform","xform","dataValidations","sheetProperties","sheetFormatProperties","columns","tag","length","childXform","row","hyperlinks","sheetViews","sheetProtection","pageMargins","pageSeteup","autoFilter","picture","conditionalFormattings","headerFooter","rowBreaks","WorksheetWriter","options","id","name","state","_rows","_columns","_keys","_merges","add","_sheetRelsWriter","_sheetCommentsWriter","_dimensions","_rowZero","committed","_formulae","_siFormulae","conditionalFormatting","properties","Object","assign","defaultRowHeight","dyDescent","outlineLevelCol","outlineLevelRow","differentFirst","differentOddEven","oddHeader","oddFooter","evenHeader","evenFooter","firstHeader","firstFooter","pageSetup","margins","left","right","top","bottom","header","footer","orientation","horizontalDpi","verticalDpi","fitToPage","fitToWidth","fitToHeight","scale","pageOrder","blackAndWhite","draft","cellComments","errors","paperSize","undefined","showRowColHeaders","showGridLines","horizontalCentered","verticalCentered","colBreaks","useSharedStrings","_workbook","workbook","hasComments","_views","views","_media","_writeOpenWorksheet","startedData","_stream","_openStream","pause","Error","forEach","cRow","_writeRow","_writeOpenSheetData","_writeCloseSheetData","_writeAutoFilter","_writeMergeCells","_writeHyperlinks","_writeConditionalFormatting","_writeDataValidations","_writeSheetProtection","_writePageMargins","_writePageSetup","_writeBackground","_writeHeaderFooter","_writeRowBreaks","_writeLegacyData","_writeCloseWorksheet","stream","end","commit","value","_headerRowCount","reduce","pv","cv","headerCount","headers","Math","max","count","defn","column","push","key","f","each","c","col","l2n","n","iteratee","includeEmpty","_nextRow","i","getRow","hasValues","number","found","shift","rowNumber","index","values","r","address","getAddress","findRow","findCell","getCellEx","cells","dimensions","merge","intersects","master","getCell","j","cf","filter","splice","Function","imageId","_background","password","Promise","resolve","sheet","spinCount","Number","isFinite","round","algorithmName","saltValue","randomBytes","toString","hashValue","convertPasswordToHash","text","reset","addText","write","xmlBuf","sheetPropertiesModel","outlineProperties","tabColor","toXml","sheetFormatPropertiesModel","defaultColWidth","_writeSheetProperties","_writeSheetFormatProperties","cols","toModel","prepare","styles","_write","_writeColumns","height","model","sharedStrings","hyperlinksProxy","merges","formulae","siFormulae","comments","addComments","_hyperlinks","image","getImage","pictureId","addMedia","Target","Type","Image","rId","vmlRelId","module","exports"],"mappings":"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","sourcesContent":["const _ = require('../../utils/under-dash');\r\n\r\nconst RelType = require('../../xlsx/rel-type');\r\n\r\nconst colCache = require('../../utils/col-cache');\r\nconst Encryptor = require('../../utils/encryptor');\r\nconst Dimensions = require('../../doc/range');\r\nconst StringBuf = require('../../utils/string-buf');\r\n\r\nconst Row = require('../../doc/row');\r\nconst Column = require('../../doc/column');\r\n\r\nconst SheetRelsWriter = require('./sheet-rels-writer');\r\nconst SheetCommentsWriter = require('./sheet-comments-writer');\r\nconst DataValidations = require('../../doc/data-validations');\r\n\r\nconst xmlBuffer = new StringBuf();\r\n\r\n// ============================================================================================\r\n// Xforms\r\nconst ListXform = require('../../xlsx/xform/list-xform');\r\nconst DataValidationsXform = require('../../xlsx/xform/sheet/data-validations-xform');\r\nconst SheetPropertiesXform = require('../../xlsx/xform/sheet/sheet-properties-xform');\r\nconst SheetFormatPropertiesXform = require('../../xlsx/xform/sheet/sheet-format-properties-xform');\r\nconst ColXform = require('../../xlsx/xform/sheet/col-xform');\r\nconst RowXform = require('../../xlsx/xform/sheet/row-xform');\r\nconst HyperlinkXform = require('../../xlsx/xform/sheet/hyperlink-xform');\r\nconst SheetViewXform = require('../../xlsx/xform/sheet/sheet-view-xform');\r\nconst SheetProtectionXform = require('../../xlsx/xform/sheet/sheet-protection-xform');\r\nconst PageMarginsXform = require('../../xlsx/xform/sheet/page-margins-xform');\r\nconst PageSetupXform = require('../../xlsx/xform/sheet/page-setup-xform');\r\nconst AutoFilterXform = require('../../xlsx/xform/sheet/auto-filter-xform');\r\nconst PictureXform = require('../../xlsx/xform/sheet/picture-xform');\r\nconst ConditionalFormattingsXform = require('../../xlsx/xform/sheet/cf/conditional-formattings-xform');\r\nconst HeaderFooterXform = require('../../xlsx/xform/sheet/header-footer-xform');\r\nconst RowBreaksXform = require('../../xlsx/xform/sheet/row-breaks-xform');\r\n\r\n// since prepare and render are functional, we can use singletons\r\nconst xform = {\r\n  dataValidations: new DataValidationsXform(),\r\n  sheetProperties: new SheetPropertiesXform(),\r\n  sheetFormatProperties: new SheetFormatPropertiesXform(),\r\n  columns: new ListXform({tag: 'cols', length: false, childXform: new ColXform()}),\r\n  row: new RowXform(),\r\n  hyperlinks: new ListXform({tag: 'hyperlinks', length: false, childXform: new HyperlinkXform()}),\r\n  sheetViews: new ListXform({tag: 'sheetViews', length: false, childXform: new SheetViewXform()}),\r\n  sheetProtection: new SheetProtectionXform(),\r\n  pageMargins: new PageMarginsXform(),\r\n  pageSeteup: new PageSetupXform(),\r\n  autoFilter: new AutoFilterXform(),\r\n  picture: new PictureXform(),\r\n  conditionalFormattings: new ConditionalFormattingsXform(),\r\n  headerFooter: new HeaderFooterXform(),\r\n  rowBreaks: new RowBreaksXform(),\r\n};\r\n\r\n// ============================================================================================\r\n\r\nclass WorksheetWriter {\r\n  constructor(options) {\r\n    // in a workbook, each sheet will have a number\r\n    this.id = options.id;\r\n\r\n    // and a name\r\n    this.name = options.name || `Sheet${this.id}`;\r\n\r\n    // add a state\r\n    this.state = options.state || 'visible';\r\n\r\n    // rows are stored here while they need to be worked on.\r\n    // when they are committed, they will be deleted.\r\n    this._rows = [];\r\n\r\n    // column definitions\r\n    this._columns = null;\r\n\r\n    // column keys (addRow convenience): key ==> this._columns index\r\n    this._keys = {};\r\n\r\n    // keep a record of all row and column pageBreaks\r\n    this._merges = [];\r\n    this._merges.add = function() {}; // ignore cell instruction\r\n\r\n    // keep record of all hyperlinks\r\n    this._sheetRelsWriter = new SheetRelsWriter(options);\r\n\r\n    this._sheetCommentsWriter = new SheetCommentsWriter(this, this._sheetRelsWriter, options);\r\n\r\n    // keep a record of dimensions\r\n    this._dimensions = new Dimensions();\r\n\r\n    // first uncommitted row\r\n    this._rowZero = 1;\r\n\r\n    // committed flag\r\n    this.committed = false;\r\n\r\n    // for data validations\r\n    this.dataValidations = new DataValidations();\r\n\r\n    // for sharing formulae\r\n    this._formulae = {};\r\n    this._siFormulae = 0;\r\n\r\n    // keep a record of conditionalFormattings\r\n    this.conditionalFormatting = [];\r\n\r\n    // keep a record of all row and column pageBreaks\r\n    this.rowBreaks = [];\r\n\r\n    // for default row height, outline levels, etc\r\n    this.properties = Object.assign(\r\n      {},\r\n      {\r\n        defaultRowHeight: 15,\r\n        dyDescent: 55,\r\n        outlineLevelCol: 0,\r\n        outlineLevelRow: 0,\r\n      },\r\n      options.properties\r\n    );\r\n\r\n    this.headerFooter = Object.assign(\r\n      {},\r\n      {\r\n        differentFirst: false,\r\n        differentOddEven: false,\r\n        oddHeader: null,\r\n        oddFooter: null,\r\n        evenHeader: null,\r\n        evenFooter: null,\r\n        firstHeader: null,\r\n        firstFooter: null,\r\n      },\r\n      options.headerFooter\r\n    );\r\n\r\n    // for all things printing\r\n    this.pageSetup = Object.assign(\r\n      {},\r\n      {\r\n        margins: {left: 0.7, right: 0.7, top: 0.75, bottom: 0.75, header: 0.3, footer: 0.3},\r\n        orientation: 'portrait',\r\n        horizontalDpi: 4294967295,\r\n        verticalDpi: 4294967295,\r\n        fitToPage: !!(\r\n          options.pageSetup &&\r\n          (options.pageSetup.fitToWidth || options.pageSetup.fitToHeight) &&\r\n          !options.pageSetup.scale\r\n        ),\r\n        pageOrder: 'downThenOver',\r\n        blackAndWhite: false,\r\n        draft: false,\r\n        cellComments: 'None',\r\n        errors: 'displayed',\r\n        scale: 100,\r\n        fitToWidth: 1,\r\n        fitToHeight: 1,\r\n        paperSize: undefined,\r\n        showRowColHeaders: false,\r\n        showGridLines: false,\r\n        horizontalCentered: false,\r\n        verticalCentered: false,\r\n        rowBreaks: null,\r\n        colBreaks: null,\r\n      },\r\n      options.pageSetup\r\n    );\r\n\r\n    // using shared strings creates a smaller xlsx file but may use more memory\r\n    this.useSharedStrings = options.useSharedStrings || false;\r\n\r\n    this._workbook = options.workbook;\r\n\r\n    this.hasComments = false;\r\n\r\n    // views\r\n    this._views = options.views || [];\r\n\r\n    // auto filter\r\n    this.autoFilter = options.autoFilter || null;\r\n\r\n    this._media = [];\r\n\r\n    // worksheet protection\r\n    this.sheetProtection = null;\r\n\r\n    // start writing to stream now\r\n    this._writeOpenWorksheet();\r\n\r\n    this.startedData = false;\r\n  }\r\n\r\n  get workbook() {\r\n    return this._workbook;\r\n  }\r\n\r\n  get stream() {\r\n    if (!this._stream) {\r\n      // eslint-disable-next-line no-underscore-dangle\r\n      this._stream = this._workbook._openStream(`/xl/worksheets/sheet${this.id}.xml`);\r\n\r\n      // pause stream to prevent 'data' events\r\n      this._stream.pause();\r\n    }\r\n    return this._stream;\r\n  }\r\n\r\n  // destroy - not a valid operation for a streaming writer\r\n  // even though some streamers might be able to, it's a bad idea.\r\n  destroy() {\r\n    throw new Error('Invalid Operation: destroy');\r\n  }\r\n\r\n  commit() {\r\n    if (this.committed) {\r\n      return;\r\n    }\r\n    // commit all rows\r\n    this._rows.forEach(cRow => {\r\n      if (cRow) {\r\n        // write the row to the stream\r\n        this._writeRow(cRow);\r\n      }\r\n    });\r\n\r\n    // we _cannot_ accept new rows from now on\r\n    this._rows = null;\r\n\r\n    if (!this.startedData) {\r\n      this._writeOpenSheetData();\r\n    }\r\n    this._writeCloseSheetData();\r\n    this._writeAutoFilter();\r\n    this._writeMergeCells();\r\n\r\n    // for some reason, Excel can't handle dimensions at the bottom of the file\r\n    // this._writeDimensions();\r\n\r\n    this._writeHyperlinks();\r\n    this._writeConditionalFormatting();\r\n    this._writeDataValidations();\r\n    this._writeSheetProtection();\r\n    this._writePageMargins();\r\n    this._writePageSetup();\r\n    this._writeBackground();\r\n    this._writeHeaderFooter();\r\n    this._writeRowBreaks();\r\n\r\n    // Legacy Data tag for comments\r\n    this._writeLegacyData();\r\n\r\n    this._writeCloseWorksheet();\r\n    // signal end of stream to workbook\r\n    this.stream.end();\r\n\r\n    this._sheetCommentsWriter.commit();\r\n    // also commit the hyperlinks if any\r\n    this._sheetRelsWriter.commit();\r\n\r\n    this.committed = true;\r\n  }\r\n\r\n  // return the current dimensions of the writer\r\n  get dimensions() {\r\n    return this._dimensions;\r\n  }\r\n\r\n  get views() {\r\n    return this._views;\r\n  }\r\n\r\n  // =========================================================================\r\n  // Columns\r\n\r\n  // get the current columns array.\r\n  get columns() {\r\n    return this._columns;\r\n  }\r\n\r\n  // set the columns from an array of column definitions.\r\n  // Note: any headers defined will overwrite existing values.\r\n  set columns(value) {\r\n    // calculate max header row count\r\n    this._headerRowCount = value.reduce((pv, cv) => {\r\n      const headerCount = (cv.header && 1) || (cv.headers && cv.headers.length) || 0;\r\n      return Math.max(pv, headerCount);\r\n    }, 0);\r\n\r\n    // construct Column objects\r\n    let count = 1;\r\n    const columns = (this._columns = []);\r\n    value.forEach(defn => {\r\n      const column = new Column(this, count++, false);\r\n      columns.push(column);\r\n      column.defn = defn;\r\n    });\r\n  }\r\n\r\n  getColumnKey(key) {\r\n    return this._keys[key];\r\n  }\r\n\r\n  setColumnKey(key, value) {\r\n    this._keys[key] = value;\r\n  }\r\n\r\n  deleteColumnKey(key) {\r\n    delete this._keys[key];\r\n  }\r\n\r\n  eachColumnKey(f) {\r\n    _.each(this._keys, f);\r\n  }\r\n\r\n  // get a single column by col number. If it doesn't exist, it and any gaps before it\r\n  // are created.\r\n  getColumn(c) {\r\n    if (typeof c === 'string') {\r\n      // if it matches a key'd column, return that\r\n      const col = this._keys[c];\r\n      if (col) return col;\r\n\r\n      // otherwise, assume letter\r\n      c = colCache.l2n(c);\r\n    }\r\n    if (!this._columns) {\r\n      this._columns = [];\r\n    }\r\n    if (c > this._columns.length) {\r\n      let n = this._columns.length + 1;\r\n      while (n <= c) {\r\n        this._columns.push(new Column(this, n++));\r\n      }\r\n    }\r\n    return this._columns[c - 1];\r\n  }\r\n\r\n  // =========================================================================\r\n  // Rows\r\n  get _nextRow() {\r\n    return this._rowZero + this._rows.length;\r\n  }\r\n\r\n  // iterate over every uncommitted row in the worksheet, including maybe empty rows\r\n  eachRow(options, iteratee) {\r\n    if (!iteratee) {\r\n      iteratee = options;\r\n      options = undefined;\r\n    }\r\n    if (options && options.includeEmpty) {\r\n      const n = this._nextRow;\r\n      for (let i = this._rowZero; i < n; i++) {\r\n        iteratee(this.getRow(i), i);\r\n      }\r\n    } else {\r\n      this._rows.forEach(row => {\r\n        if (row.hasValues) {\r\n          iteratee(row, row.number);\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  _commitRow(cRow) {\r\n    // since rows must be written in order, we commit all rows up till and including cRow\r\n    let found = false;\r\n    while (this._rows.length && !found) {\r\n      const row = this._rows.shift();\r\n      this._rowZero++;\r\n      if (row) {\r\n        this._writeRow(row);\r\n        found = row.number === cRow.number;\r\n        this._rowZero = row.number + 1;\r\n      }\r\n    }\r\n  }\r\n\r\n  get lastRow() {\r\n    // returns last uncommitted row\r\n    if (this._rows.length) {\r\n      return this._rows[this._rows.length - 1];\r\n    }\r\n    return undefined;\r\n  }\r\n\r\n  // find a row (if exists) by row number\r\n  findRow(rowNumber) {\r\n    const index = rowNumber - this._rowZero;\r\n    return this._rows[index];\r\n  }\r\n\r\n  getRow(rowNumber) {\r\n    const index = rowNumber - this._rowZero;\r\n\r\n    // may fail if rows have been comitted\r\n    if (index < 0) {\r\n      throw new Error('Out of bounds: this row has been committed');\r\n    }\r\n    let row = this._rows[index];\r\n    if (!row) {\r\n      this._rows[index] = row = new Row(this, rowNumber);\r\n    }\r\n    return row;\r\n  }\r\n\r\n  addRow(value) {\r\n    const row = new Row(this, this._nextRow);\r\n    this._rows[row.number - this._rowZero] = row;\r\n    row.values = value;\r\n    return row;\r\n  }\r\n\r\n  // ================================================================================\r\n  // Cells\r\n\r\n  // returns the cell at [r,c] or address given by r. If not found, return undefined\r\n  findCell(r, c) {\r\n    const address = colCache.getAddress(r, c);\r\n    const row = this.findRow(address.row);\r\n    return row ? row.findCell(address.column) : undefined;\r\n  }\r\n\r\n  // return the cell at [r,c] or address given by r. If not found, create a new one.\r\n  getCell(r, c) {\r\n    const address = colCache.getAddress(r, c);\r\n    const row = this.getRow(address.row);\r\n    return row.getCellEx(address);\r\n  }\r\n\r\n  mergeCells(...cells) {\r\n    // may fail if rows have been comitted\r\n    const dimensions = new Dimensions(cells);\r\n\r\n    // check cells aren't already merged\r\n    this._merges.forEach(merge => {\r\n      if (merge.intersects(dimensions)) {\r\n        throw new Error('Cannot merge already merged cells');\r\n      }\r\n    });\r\n\r\n    // apply merge\r\n    const master = this.getCell(dimensions.top, dimensions.left);\r\n    for (let i = dimensions.top; i <= dimensions.bottom; i++) {\r\n      for (let j = dimensions.left; j <= dimensions.right; j++) {\r\n        if (i > dimensions.top || j > dimensions.left) {\r\n          this.getCell(i, j).merge(master);\r\n        }\r\n      }\r\n    }\r\n\r\n    // index merge\r\n    this._merges.push(dimensions);\r\n  }\r\n\r\n  // ===========================================================================\r\n  // Conditional Formatting\r\n  addConditionalFormatting(cf) {\r\n    this.conditionalFormatting.push(cf);\r\n  }\r\n\r\n  removeConditionalFormatting(filter) {\r\n    if (typeof filter === 'number') {\r\n      this.conditionalFormatting.splice(filter, 1);\r\n    } else if (filter instanceof Function) {\r\n      this.conditionalFormatting = this.conditionalFormatting.filter(filter);\r\n    } else {\r\n      this.conditionalFormatting = [];\r\n    }\r\n  }\r\n\r\n  // =========================================================================\r\n\r\n  addBackgroundImage(imageId) {\r\n    this._background = {\r\n      imageId,\r\n    };\r\n  }\r\n\r\n  getBackgroundImageId() {\r\n    return this._background && this._background.imageId;\r\n  }\r\n\r\n  // =========================================================================\r\n  // Worksheet Protection\r\n  protect(password, options) {\r\n    // TODO: make this function truly async\r\n    // perhaps marshal to worker thread or something\r\n    return new Promise(resolve => {\r\n      this.sheetProtection = {\r\n        sheet: true,\r\n      };\r\n      if (options && 'spinCount' in options) {\r\n        // force spinCount to be integer >= 0\r\n        options.spinCount = Number.isFinite(options.spinCount) ? Math.round(Math.max(0, options.spinCount)) : 100000;\r\n      }\r\n      if (password) {\r\n        this.sheetProtection.algorithmName = 'SHA-512';\r\n        this.sheetProtection.saltValue = Encryptor.randomBytes(16).toString('base64');\r\n        this.sheetProtection.spinCount = options && 'spinCount' in options ? options.spinCount : 100000; // allow user specified spinCount\r\n        this.sheetProtection.hashValue = Encryptor.convertPasswordToHash(\r\n          password,\r\n          'SHA512',\r\n          this.sheetProtection.saltValue,\r\n          this.sheetProtection.spinCount\r\n        );\r\n      }\r\n      if (options) {\r\n        this.sheetProtection = Object.assign(this.sheetProtection, options);\r\n        if (!password && 'spinCount' in options) {\r\n          delete this.sheetProtection.spinCount;\r\n        }\r\n      }\r\n      resolve();\r\n    });\r\n  }\r\n\r\n  unprotect() {\r\n    this.sheetProtection = null;\r\n  }\r\n\r\n  // ================================================================================\r\n\r\n  _write(text) {\r\n    xmlBuffer.reset();\r\n    xmlBuffer.addText(text);\r\n    this.stream.write(xmlBuffer);\r\n  }\r\n\r\n  _writeSheetProperties(xmlBuf, properties, pageSetup) {\r\n    const sheetPropertiesModel = {\r\n      outlineProperties: properties && properties.outlineProperties,\r\n      tabColor: properties && properties.tabColor,\r\n      pageSetup:\r\n        pageSetup && pageSetup.fitToPage\r\n          ? {\r\n              fitToPage: pageSetup.fitToPage,\r\n            }\r\n          : undefined,\r\n    };\r\n\r\n    xmlBuf.addText(xform.sheetProperties.toXml(sheetPropertiesModel));\r\n  }\r\n\r\n  _writeSheetFormatProperties(xmlBuf, properties) {\r\n    const sheetFormatPropertiesModel = properties\r\n      ? {\r\n          defaultRowHeight: properties.defaultRowHeight,\r\n          dyDescent: properties.dyDescent,\r\n          outlineLevelCol: properties.outlineLevelCol,\r\n          outlineLevelRow: properties.outlineLevelRow,\r\n        }\r\n      : undefined;\r\n    if (properties.defaultColWidth) {\r\n      sheetFormatPropertiesModel.defaultColWidth = properties.defaultColWidth;\r\n    }\r\n\r\n    xmlBuf.addText(xform.sheetFormatProperties.toXml(sheetFormatPropertiesModel));\r\n  }\r\n\r\n  _writeOpenWorksheet() {\r\n    xmlBuffer.reset();\r\n\r\n    xmlBuffer.addText('<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>');\r\n    xmlBuffer.addText(\r\n      '<worksheet xmlns=\"http://schemas.openxmlformats.org/spreadsheetml/2006/main\"' +\r\n        ' xmlns:r=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships\"' +\r\n        ' xmlns:mc=\"http://schemas.openxmlformats.org/markup-compatibility/2006\"' +\r\n        ' mc:Ignorable=\"x14ac\"' +\r\n        ' xmlns:x14ac=\"http://schemas.microsoft.com/office/spreadsheetml/2009/9/ac\">'\r\n    );\r\n\r\n    this._writeSheetProperties(xmlBuffer, this.properties, this.pageSetup);\r\n\r\n    xmlBuffer.addText(xform.sheetViews.toXml(this.views));\r\n\r\n    this._writeSheetFormatProperties(xmlBuffer, this.properties);\r\n\r\n    this.stream.write(xmlBuffer);\r\n  }\r\n\r\n  _writeColumns() {\r\n    const cols = Column.toModel(this.columns);\r\n    if (cols) {\r\n      xform.columns.prepare(cols, {styles: this._workbook.styles});\r\n      this.stream.write(xform.columns.toXml(cols));\r\n    }\r\n  }\r\n\r\n  _writeOpenSheetData() {\r\n    this._write('<sheetData>');\r\n  }\r\n\r\n  _writeRow(row) {\r\n    if (!this.startedData) {\r\n      this._writeColumns();\r\n      this._writeOpenSheetData();\r\n      this.startedData = true;\r\n    }\r\n\r\n    if (row.hasValues || row.height) {\r\n      const {model} = row;\r\n      const options = {\r\n        styles: this._workbook.styles,\r\n        sharedStrings: this.useSharedStrings ? this._workbook.sharedStrings : undefined,\r\n        hyperlinks: this._sheetRelsWriter.hyperlinksProxy,\r\n        merges: this._merges,\r\n        formulae: this._formulae,\r\n        siFormulae: this._siFormulae,\r\n        comments: [],\r\n      };\r\n      xform.row.prepare(model, options);\r\n      this.stream.write(xform.row.toXml(model));\r\n\r\n      if (options.comments.length) {\r\n        this.hasComments = true;\r\n        this._sheetCommentsWriter.addComments(options.comments);\r\n      }\r\n    }\r\n  }\r\n\r\n  _writeCloseSheetData() {\r\n    this._write('</sheetData>');\r\n  }\r\n\r\n  _writeMergeCells() {\r\n    if (this._merges.length) {\r\n      xmlBuffer.reset();\r\n      xmlBuffer.addText(`<mergeCells count=\"${this._merges.length}\">`);\r\n      this._merges.forEach(merge => {\r\n        xmlBuffer.addText(`<mergeCell ref=\"${merge}\"/>`);\r\n      });\r\n      xmlBuffer.addText('</mergeCells>');\r\n\r\n      this.stream.write(xmlBuffer);\r\n    }\r\n  }\r\n\r\n  _writeHyperlinks() {\r\n    // eslint-disable-next-line no-underscore-dangle\r\n    this.stream.write(xform.hyperlinks.toXml(this._sheetRelsWriter._hyperlinks));\r\n  }\r\n\r\n  _writeConditionalFormatting() {\r\n    const options = {\r\n      styles: this._workbook.styles,\r\n    };\r\n    xform.conditionalFormattings.prepare(this.conditionalFormatting, options);\r\n    this.stream.write(xform.conditionalFormattings.toXml(this.conditionalFormatting));\r\n  }\r\n\r\n  _writeRowBreaks() {\r\n    this.stream.write(xform.rowBreaks.toXml(this.rowBreaks));\r\n  }\r\n\r\n  _writeDataValidations() {\r\n    this.stream.write(xform.dataValidations.toXml(this.dataValidations.model));\r\n  }\r\n\r\n  _writeSheetProtection() {\r\n    this.stream.write(xform.sheetProtection.toXml(this.sheetProtection));\r\n  }\r\n\r\n  _writePageMargins() {\r\n    this.stream.write(xform.pageMargins.toXml(this.pageSetup.margins));\r\n  }\r\n\r\n  _writePageSetup() {\r\n    this.stream.write(xform.pageSeteup.toXml(this.pageSetup));\r\n  }\r\n\r\n  _writeHeaderFooter() {\r\n    this.stream.write(xform.headerFooter.toXml(this.headerFooter));\r\n  }\r\n\r\n  _writeAutoFilter() {\r\n    this.stream.write(xform.autoFilter.toXml(this.autoFilter));\r\n  }\r\n\r\n  _writeBackground() {\r\n    if (this._background) {\r\n      if (this._background.imageId !== undefined) {\r\n        const image = this._workbook.getImage(this._background.imageId);\r\n        const pictureId = this._sheetRelsWriter.addMedia({\r\n          Target: `../media/${image.name}`,\r\n          Type: RelType.Image,\r\n        });\r\n\r\n        this._background = {\r\n          ...this._background,\r\n          rId: pictureId,\r\n        };\r\n      }\r\n      this.stream.write(xform.picture.toXml({rId: this._background.rId}));\r\n    }\r\n  }\r\n\r\n  _writeLegacyData() {\r\n    if (this.hasComments) {\r\n      xmlBuffer.reset();\r\n      xmlBuffer.addText(`<legacyDrawing r:id=\"${this._sheetCommentsWriter.vmlRelId}\"/>`);\r\n      this.stream.write(xmlBuffer);\r\n    }\r\n  }\r\n\r\n  _writeDimensions() {\r\n    // for some reason, Excel can't handle dimensions at the bottom of the file\r\n    // and we don't know the dimensions until the commit, so don't write them.\r\n    // this._write('<dimension ref=\"' + this._dimensions + '\"/>');\r\n  }\r\n\r\n  _writeCloseWorksheet() {\r\n    this._write('</worksheet>');\r\n  }\r\n}\r\n\r\nmodule.exports = WorksheetWriter;\r\n"],"file":"worksheet-writer.js"}